{% capture page_url %}{{ site.url }}{{ site.baseurl }}{{ page.url | replace:'index.html','' }}{% endcapture %}
{% capture description %}{% if page.description %}{{ page.description | strip_html | strip_newlines }}{% else %}{{ site.description }}{% endif %}{% endcapture %}
{% capture id_number %}{{ collection.id_0 }}{% if collection.id_1 %}.{{ collection.id_1 }}{% endif %}{% if collection.id_2 %}.{{ collection.id_2 }}{% endif %}{% if collection.id_3 %}.{{ collection.id_3 }}{% endif %}{% endcapture %}

{
  "@context": "http://schema.org/",
  "@type": "Collection",
  "name": "{{collection.title}}",
  "description": "{{description}}",
  "datePublished": "{{system_mtime}}",
  {% for agent in agents %}
    {% if {{agent.role}} == 'creator' %}
      {% if agent.ref %}
          <!-- there is an external .json file to read agent_detail from -->
          {% if agent.ref contains "corporate_entities" %}
            {% assign schtype = "Organization" %}
            {% assign type = "organizations" %}
            {% assign label = "name" %}
            {% capture id %}{{agent.ref | replace: '/agents/corporate_entities/', '' }}{% endcapture %}
            {% assign agent_detail = site.data.agents.corporate_entities[{{id}}] %}
          {% elsif agent.ref contains "families" %}
            {% assign schtype = "Person" %}
            {% assign type = "families" %}
            {% assign label = "familyName" %}
            {% capture id %}{{agent.ref | replace: '/agents/families/', '' }}{% endcapture %}
            {% assign agent_detail = site.data.agents.families[{{id}}] %}
          {% elsif agent.ref contains "people" %}
            {% assign schtype = "Person" %}
            {% assign type = "people" %}
            {% assign label = "name" %}
            {% capture id %}{{agent.ref | replace: '/agents/people/', '' }}{% endcapture %}
            {% assign agent_detail = site.data.agents.people[{{id}}] %}
          {% endif %}
      {% else %}
        <!-- no external .json file - just use agent as agent_detail -->
        {% assign agent_detail = agent %}
        {% assign type = false %}
        {% assign label = false %}
        {% assign id = false %}
      {% endif %}
      {% if agent_detail %}
  "creator": [
        {% if type and id %}
        {
            "@type": "{{schtype}}",
            "@id": "{{site.url}}{{site.baseurl}}/{{type}}/{{id}}",
            "{{label}}": "{{agent_detail.title}}"
        {% else %}
        {
            "@type": "Thing",
            "name": "{{agent_detail.title}}"
      {% endif %}
        }
        {% if forloop.last == false %}
        ,
        {% endif %}
  ],
      {% endif %}
    {% elseif {{agent.role}} == 'contributor' %}
      {% if agent.ref %}
          <!-- there is an external .json file to read agent_detail from -->
          {% if agent.ref contains "corporate_entities" %}
            {% assign schtype = "Organization" %}
            {% assign type = "organizations" %}
            {% assign label = "name" %}
            {% capture id %}{{agent.ref | replace: '/agents/corporate_entities/', '' }}{% endcapture %}
            {% assign agent_detail = site.data.agents.corporate_entities[{{id}}] %}
          {% elsif agent.ref contains "families" %}
            {% assign schtype = "Person" %}
            {% assign type = "families" %}
            {% assign label = "familyName" %}
            {% capture id %}{{agent.ref | replace: '/agents/families/', '' }}{% endcapture %}
            {% assign agent_detail = site.data.agents.families[{{id}}] %}
          {% elsif agent.ref contains "people" %}
            {% assign schtype = "Person" %}
            {% assign type = "people" %}
            {% assign label = "name" %}
            {% capture id %}{{agent.ref | replace: '/agents/people/', '' }}{% endcapture %}
            {% assign agent_detail = site.data.agents.people[{{id}}] %}
          {% endif %}
      {% else %}
        <!-- no external .json file - just use agent as agent_detail -->
          {% assign agent_detail = agent %}
          {% assign type = false %}
          {% assign label = false %}
          {% assign id = false %}
      {% endif %}
      {% if agent_detail %}
  "contributor": [
          {% if type and id %}
        {
            "@type": "{{schtype}}",
            "@id": "{{site.url}}{{site.baseurl}}/{{type}}/{{id}}",
            "{{label}}": "{{agent_detail.title}}"
          {% else %}
        {
            "@type": "Thing",
            "name": "{{agent_detail.title}}"
          {% endif %}
        }
          {% if forloop.last == false %}
        ,
          {% endif %}
  ],
      {% endif %}
    {% endif %}  
  {% endfor %}
    "temporalCoverage": "{{collection.dates[0].expression}}",
    {% for subject in subjects %}
      {% if subject.ref %}
        {% capture subject_id %}{{subject.ref | replace: '/subjects/', ''}}{% endcapture %}
        {% assign subject_detail = site.data.subjects[{{subject_id}}] %}
      {% else %}
        {% assign subject_detail = subject %}
      {% endif %}
    "about": [
      "{{subject_detail.title}}"
    {% if forloop.last == false %}
      ,
     {% endif %}
        ],
    {% endfor %}
  "url": "{{page_url}}",
  "offers": {
      "@type": "Offer",
      "availability": "https://schema.org/InStoreOnly",
      "serialNumber": "{{id_number}}",
      "priceCurrency": "USD",
      "price": 0,
      "businessFunction": "http://purl.org/goodrelations/v1#ProvideService",
      "offeredBy": {
             "@type": "{{instType}}",
             {% if instID == '' %}
             {% else  %}
             "@id": "{{instID}}",
             {% endif %}
             "name": "{{instName}}",
             "url": "{{instURL}}",
             "image": "{{instImage}}",
             {% if instSameAs == '' %}
             {% else  %}
             "sameAs": "{{instSameAs}}",
             {% endif %}
             "priceRange": 0,
             {% if instAltName == '' %}
             {% else  %}
             "alternateName": "{{instAltName}}",
             {% endif %}
             "telephone": "{{instPhone}}",
             "address": {
                     "@type": "PostalAddress",
                     "streetAddress": "{{instStreetAddress}",
                     "addressLocality": "{{instCity}}",
                     "addressRegion": "{{instState}}",
                     "postalCode": "{{instZipCode}}"
             {% if parentOrg == 'Yes' %}
             },
             "parentOrganization": {
                     "@type": "{{parentType}}",
                     {% if parentID == '' %}
                     {% else  %}
                     "@id": "{{parentID}}",
                     {% endif %}
                     "name": "{{parentName}}",
                     {% if parentSameAs == '' %}
                     {% else  %}
                     "sameAs": "{{parentSameAs}}",
                     {% endif %}
                     "url": "{{parentURL}}"
             }
      }
  }
}
             {% else  %}
             }
      }
  }
}
             {% endif %}
